system sh/stop_dnodes.sh
system sh/deploy.sh -n dnode1 -i 1
system sh/deploy.sh -n dnode2 -i 2
system sh/deploy.sh -n dnode3 -i 3
system sh/exec.sh -n dnode1 -s start
system sh/exec.sh -n dnode2 -s start
system sh/exec.sh -n dnode3 -s start

$loop_cnt = 0
check_dnode_ready:
	$loop_cnt = $loop_cnt + 1
	sleep 200
	if $loop_cnt == 10 then
	  print ====> dnode not ready!
		return -1
	endi
sql show dnodes
print ===> $rows $data00 $data01 $data02 $data03 $data04 $data05
if $data00 != 1 then
  return -1
endi
if $data04 != ready then
  goto check_dnode_ready
endi

sql connect
sql create dnode $hostname port 7200
sql create dnode $hostname port 7300

$loop_cnt = 0
check_dnode_ready_1:
	$loop_cnt = $loop_cnt + 1
	sleep 200
	if $loop_cnt == 10 then
	  print ====> dnode not ready!
		return -1
	endi
sql show dnodes
print ===> rows: $rows 
print ===> $data00 $data01 $data02 $data03 $data04 $data05
print ===> $data10 $data11 $data12 $data13 $data14 $data15
print ===> $data20 $data21 $data22 $data23 $data24 $data25
if $data00 != 1 then
  return -1
endi
if $data01 != localhost:7100 then
  return -1
endi
if $data04 != ready then
  goto check_dnode_ready_1
endi
if $data14 != ready then
  goto check_dnode_ready_1
endi
if $data24 != ready then
  goto check_dnode_ready_1
endi

print ============= create database
#database_option: {
#    BLOCKS value       [3~1000, default: 6]
#  | CACHE value        [default: 16M]
#  | CACHELAST value    [0, 1, 2, 3]
#  | COMP               [0 | 1 | 2]
#  | DAYS value         [unit is minutes]
#  | FSYNC value        [0 ~ 180000 ms]
#  | MAXROWS value      [default: 4096]
#  | MINROWS value      [default: 100]
#  | KEEP value         [days, 365000]
#  | PRECISION          ['ms' | 'us' | 'ns']
#  | QUORUM value       [1 | 2]
#  | REPLICA value      [1 | 3]
#  | TTL value          [unit is day, min=1]
#  | WAL value          [1 | 2]
#  | VGROUPS value      [default: 2]
#  | SINGLE_STABLE      [0 | 1]
#  | STREAM_MODE        [0 | 1]

sql create database db BLOCKS 7 CACHE 3 CACHELAST 3 COMP 0 DAYS 240 FSYNC 1000 MAXROWS 8000 MINROWS 10 KEEP 1000 PRECISION 'ns' QUORUM 1 REPLICA 3 TTL 7 WAL 2 VGROUPS 6 SINGLE_STABLE 1 STREAM_MODE 1
sql show databases
print rows: $rows
print $data00 $data01 $data02 $data03 $data04 $data05 $data06 $data07 $data08 $data09
print $data10 $data11 $data12 $data13 $data14 $data15 $data16 $data17 $data18 $data19
print ====> dataX_db
print $data0_db $data1_db $data2_db $data3_db $data4_db $data5_db $data6_db $data7_db $data8_db $data9_db $data10_db $data11_db $data12_db $data13_db $data14_db $data15_db $data16_db $data17_db

if $rows != 2 then
  return -1
endi
if $data0_db != db then # name
  return -1
endi
if $data2_db != 6 then  # vgroups
  return -1
endi
if $data3_db != 0 then  # ntables
  return -1
endi
if $data4_db != 3 then  # replica
  return -1
endi
if $data5_db != 1 then  # quorum
  return -1
endi
if $data6_db != 240 then  # days
  return -1
endi
if $data7_db != 1000,1000,1000 then # keep
  return -1
endi
if $data8_db != 3 then  # cache
  return -1
endi
if $data9_db != 7 then  # blocks
  return -1
endi
if $data10_db != 10 then  # minrows
  return -1
endi
if $data11_db != 8000 then  # maxrows
  return -1
endi
if $data12_db != 2 then  # wal
  return -1
endi
if $data13_db != 1000 then  # fsync
  return -1
endi
if $data14_db != 0 then  # comp
  return -1
endi
if $data15_db != 3 then  # cachelast
  return -1
endi
if $data16_db != ns then  # precision
  return -1
endi

print ============== not support modify options: name, create_time, vgroups, ntables
sql_error alter database db name dba
sql_error alter database db create_time "2022-03-03 15:08:13.329"
sql_error alter database db vgroups -1
sql_error alter database db vgroups 0
sql_error alter database db vgroups 2
sql_error alter database db vgroups 20
sql_error alter database db ntables -1
sql_error alter database db ntables 0
sql_error alter database db ntables 1
sql_error alter database db ntables 10

#print ============== modify replica
sql_error alter database db replica 2
sql_error alter database db replica 5
sql_error alter database db replica -1
sql_error alter database db replica 0
#sql alter database db replica 1
#sql show databases
#print replica: $data4_db
#if $data4_db != 1 then 
#  return -1
#endi
#sql alter database db replica 3
#sql show databases
#print replica: $data4_db
#if $data4_db != 3 then 
#  return -1
#endi

print ============== modify quorum
sql alter database db quorum 2
sql show databases
print quorum $data5_db
if $data5_db != 2 then 
  return -1
endi
sql alter database db quorum 1
sql show databases
print quorum $data5_db
if $data5_db != 1 then 
  return -1
endi

sql_error alter database db quorum -1
sql_error alter database db quorum 0
sql_error alter database db quorum 3
sql_error alter database db quorum 4
sql_error alter database db quorum 5

#print ============== modify days
#sql alter database db days 480
#sql show databases
#print days $data6_db
#if $data6_db != 480 then  # days
#  return -1
#endi
#sql alter database db days 360
#sql show databases
#print days $data6_db
#if $data6_db != 360 then  # days
#  return -1
#endi

sql_error alter database db days 0
#sql_error alter database db days 14400  # set over than keep


print ============== modify keep
sql alter database db keep 2000
sql show databases
print keep $data7_db
if $data7_db != 1000,1000,2000 then
  return -1
endi

#sql alter database db keep 1000,2000
#sql show databases
#print keep $data7_db
#if $data7_db != 500,500,500 then 
#  return -1
#endi

#sql alter database db keep 40,50
#sql alter database db keep 30,31
#sql alter database db keep 20
#sql_error alter database db keep 10.0
#sql_error alter database db keep 9
#sql_error alter database db keep 1
sql_error alter database db keep 0
sql_error alter database db keep -1
#sql_error alter database db keep 365001

print ============== modify cache
#sql alter database db cache 12
#sql show databases
#print cache $data8_db
#if $data8_db != 12 then 
#  return -1
#endi
#sql alter database db cache 1
#sql show databases
#print cache $data8_db
#if $data8_db != 6 then 
#  return -1
#endi
#
#sql_error alter database db cache 60
#sql_error alter database db cache 50
#sql_error alter database db cache 20
#sql_error alter database db cache 3
#sql_error alter database db cache 129
#sql_error alter database db cache 300
sql_error alter database db cache 0
sql_error alter database db cache -1

print ============== modify blocks
sql alter database db blocks 3
sql show databases
print blocks $data9_db
if $data9_db != 3 then 
  return -1
endi
sql alter database db blocks 11
sql show databases
print blocks $data9_db
if $data9_db != 11 then 
  return -1
endi

sql alter database db blocks 40
sql alter database db blocks 30
sql alter database db blocks 20
sql alter database db blocks 10
sql_error alter database db blocks 2
sql_error alter database db blocks 1
sql_error alter database db blocks 0
sql_error alter database db blocks -1
sql_error alter database db blocks 10001

#print ============== modify minrows
#sql alter database db minrows 8
#sql show databases
#print minrows $data10_db
#if $data10_db != 8 then 
#  return -1
#endi
#sql alter database db minrows 200
#sql show databases
#print minrows $data10_db
#if $data10_db != 200 then 
#  return -1
#endi
#
#sql alter database db minrows 11
#sql show databases
#print minrows $data10_db
#if $data10_db != 11 then 
#  return -1
#endi
#sql_error alter database db minrows 8000
#sql_error alter database db minrows 8001

#print ============== modify maxrows
#sql alter database db maxrows 1000
#sql show databases
#print maxrows $data11_db
#if $data11_db != 1000 then 
#  return -1
#endi
#sql alter database db maxrows 2000
#sql show databases
#print maxrows $data11_db
#if $data11_db != 2000 then 
#  return -1
#endi
#
#sql_error alter database db maxrows 11  # equal minrows
#sql_error alter database db maxrows 10  # little than minrows

print ============== step wal
sql alter database db wal 1
sql show databases
print wal $data12_db
if $data12_db != 1 then 
  return -1
endi
sql alter database db wal 2
sql show databases
print wal $data12_db
if $data12_db != 2 then 
  return -1
endi

sql_error alter database db wal 0
sql_error alter database db wal 3
sql_error alter database db wal 100
sql_error alter database db wal -1

print ============== modify fsync
sql alter database db fsync 2000
sql show databases
print fsync $data13_db
if $data13_db != 2000 then 
  return -1
endi
sql alter database db fsync 500
sql show databases
print fsync $data13_db
if $data13_db != 500 then 
  return -1
endi
sql_error alter database db fsync 0
sql_error alter database db fsync -1

print ============== modify comp
sql alter database db comp 1
sql show databases
print comp $data14_db
if $data14_db != 1 then 
  return -1
endi
sql alter database db comp 2
sql show databases
print comp $data14_db
if $data14_db != 2 then 
  return -1
endi
sql alter database db comp 1
sql show databases
print comp $data14_db
if $data14_db != 1 then 
  return -1
endi
sql alter database db comp 0
sql show databases
print comp $data14_db
if $data14_db != 0 then 
  return -1
endi

sql_error alter database db comp 3
sql_error alter database db comp 4
sql_error alter database db comp 5
sql_error alter database db comp -1

print ============== modify cachelast [0, 1, 2, 3]
sql alter database db cachelast 2
sql show databases
print cachelast $data15_db
if $data15_db != 2 then 
  return -1
endi
sql alter database db cachelast 1
sql show databases
print cachelast $data15_db
if $data15_db != 1 then 
  return -1
endi
sql alter database db cachelast 0
sql show databases
print cachelast $data15_db
if $data15_db != 0 then 
  return -1
endi
sql alter database db cachelast 2
sql show databases
print cachelast $data15_db
if $data15_db != 2 then 
  return -1
endi
sql alter database db cachelast 3
sql show databases
print cachelast $data15_db
if $data15_db != 3 then 
  return -1
endi

sql_error alter database db comp 4
sql_error alter database db comp 10
sql_error alter database db comp -1

print ============== modify precision
sql alter database db precision 'ms'
sql show databases
print precision $data16_db
if $data16_db != ms then 
  return -1
endi
sql alter database db precision 'us'
sql show databases
print precision $data16_db
if $data16_db != us then 
  return -1
endi
sql alter database db precision 'ns'
sql show databases
print precision $data16_db
if $data16_db != ns then 
  return -1
endi

sql_error alter database db prec 'xs'

#system sh/exec.sh -n dnode1 -s stop -x SIGINT
